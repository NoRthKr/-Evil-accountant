<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evil Finance Dashboard - Cloud Sync</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #6C5CE7;
            --primary-dark: #4834D4;
            --success: #2ecc71;
            --danger: #ff7675;
            --bg: #F4F7FE;
            --shadow-3d: 0 15px 35px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; font-family: 'Kanit', sans-serif; }
        body { margin: 0; background: var(--bg); overflow-x: hidden; }

        /* --- LOGIN SCREEN --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; transition: 0.5s;
        }
        .pin-container { display: flex; gap: 10px; margin: 20px 0; }
        .pin-dot {
            width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;
            transition: 0.2s;
        }
        .pin-dot.active { background: white; transform: scale(1.2); }
        .numpad {
            display: grid; grid-template-columns: repeat(3, 80px); gap: 15px;
            margin-top: 20px;
        }
        .num-btn {
            width: 80px; height: 80px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1); color: white; font-size: 1.5rem; cursor: pointer;
            transition: 0.2s; backdrop-filter: blur(5px);
        }
        .num-btn:active { background: white; color: var(--primary); transform: scale(0.9); }

        /* --- DASHBOARD UI --- */
        #mainApp { display: none; }

        .header {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px);
            padding: 20px 30px; margin: 20px; border-radius: 25px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow-3d); position: sticky; top: 20px; z-index: 100;
        }

        .container { max-width: 1200px; margin: auto; padding: 0 20px; }
        .card { background: white; border-radius: 25px; padding: 25px; box-shadow: var(--shadow-3d); transition: 0.4s; }
        .grid-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .grid-buckets { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }

        .summary-banner {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white;
            border-radius: 25px; padding: 30px; margin-bottom: 25px; display: flex;
            justify-content: space-between; align-items: center; box-shadow: var(--shadow-3d);
        }

        .chart-container { height: 250px; position: relative; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 15px; }
        .day {
            background: #fff; height: 80px; border-radius: 18px; position: relative;
            display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #eee;
        }
        .day:hover { background: #f0f0f0; }
        .badge {
            position: absolute; top: 5px; right: 5px; background: var(--danger);
            color: white; font-size: 10px; width: 18px; height: 18px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); z-index: 1000;
            align-items: center; justify-content: center;
        }
        .modal-content { background: white; padding: 30px; border-radius: 30px; width: 400px; box-shadow: 0 40px 80px rgba(0,0,0,0.3); }

        .btn { border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 12px; border: 1px solid #ddd; }

        @media (max-width: 900px) { .grid-charts, .grid-buckets { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="loginScreen">
    <div style="text-align:center;">
        <h1 style="margin:0; font-size: 2.5rem;">üîí Finance Lock</h1>
        <p style="opacity:0.8;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ PIN 6 ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
    </div>
    <div class="pin-container" id="pinContainer">
        <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
    </div>
    <div class="numpad">
        <button class="num-btn" onclick="pressNum('1')">1</button>
        <button class="num-btn" onclick="pressNum('2')">2</button>
        <button class="num-btn" onclick="pressNum('3')">3</button>
        <button class="num-btn" onclick="pressNum('4')">4</button>
        <button class="num-btn" onclick="pressNum('5')">5</button>
        <button class="num-btn" onclick="pressNum('6')">6</button>
        <button class="num-btn" onclick="pressNum('7')">7</button>
        <button class="num-btn" onclick="pressNum('8')">8</button>
        <button class="num-btn" onclick="pressNum('9')">9</button>
        <button class="num-btn" onclick="pressNum('C')" style="background:rgba(255,0,0,0.2)">C</button>
        <button class="num-btn" onclick="pressNum('0')">0</button>
        <button class="num-btn" onclick="clearPin()" style="font-size:1rem;">Clear</button>
    </div>
</div>

<div id="mainApp">
    <header class="header">
        <div style="display:flex; align-items:center; gap:10px;">
            <button class="btn" onclick="changeMonth(-1)">‚óÄ</button>
            <h3 id="monthLabel" style="margin:0;">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
            <button class="btn" onclick="changeMonth(1)">‚ñ∂</button>
        </div>
        <button class="btn btn-primary" style="width:auto;" onclick="openModal()">‚ûïNew Spending</button>
    </header>

    <main class="container">
        <div class="summary-banner">
            <div>
                <small style="opacity:0.9;">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
                <h1 style="margin:5px 0; font-size: 3rem;" id="grandTotalDisplay">0 ‡∏ø</h1>
            </div>
            <div style="text-align: right; background: rgba(255,255,255,0.2); padding: 15px; border-radius: 20px;">
                <p style="margin:0;">‡∏¢‡∏Å‡∏°‡∏≤: <strong id="carryOverDisplay">0 ‡∏ø</strong></p>
                <p style="margin:0;">‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <strong id="monthlyExpDisplay">0 ‡∏ø</strong></p>
            </div>
        </div>

        <section class="grid-charts">
            <div class="card">
                <h3 style="margin-top:0;">üìä Monthly Balance</h3>
                <div class="chart-container"><canvas id="barChart"></canvas></div>
            </div>
            <div class="card">
                <h3 style="margin-top:0;">üçï What's a Mix</h3>
                <div class="chart-container"><canvas id="doughnutChart"></canvas></div>
            </div>
        </section>

        <h3 style="margin-left:10px;">üìÇ Spending Type</h3>
        <section class="grid-buckets" id="buckets"></section>

        <section class="card">
            <h3 style="margin-top:0;">üóìÔ∏è Calendar</h3>
            <div class="calendar-grid" id="calendarGrid"></div>
        </section>
    </main>
</div>

<div class="modal" id="recordModal">
    <div class="modal-content">
        <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà</h2>
        <input type="date" id="formDate">
        <input type="text" id="formTitle" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
        <input type="number" id="formAmount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
        <select id="formType">
            <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (+)</option>
            <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (-)</option>
        </select>
        <select id="formCat">
            <option value="income">üí∞ Income (‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö)</option>
            <option value="safety">üõ°Ô∏è Safety</option>
            <optgroup label="üìà Investing">
                <option value="invest_stock">-- Stocks</option>
                <option value="invest_funds">-- Funds</option>
                <option value="invest_gold">-- Gold</option>
                <option value="invest_etc">-- Etc.</option>
            </optgroup>
            <option value="flex">üéà Flex Expense</option>
            <option value="fixed">üßæ Fixed Expense</option>
            <option value="lock">üöë Emergency</option>
        </select>
        <button class="btn btn-primary" onclick="saveRecord()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="btn" style="width:100%; margin-top:10px;" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
</div>

<div class="modal" id="detailsModal">
    <div class="modal-content">
        <h3 id="detailDateLabel">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</h3>
        <div id="dayList" style="max-height: 250px; overflow-y:auto;"></div>
        <button class="btn" style="width:100%; margin-top:15px;" onclick="closeDetails()">‡∏õ‡∏¥‡∏î</button>
    </div>
</div>

<script>
    // 1. FIREBASE CONFIGURATION
    const firebaseConfig = {
        apiKey: "AIzaSyCTQ0vitnT_jBCF4KcMm1rwTJjwb_KLejc",
        authDomain: "evil-finance-app.firebaseapp.com",
        databaseURL: "https://evil-finance-app-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "evil-finance-app",
        storageBucket: "evil-finance-app.firebasestorage.app",
        messagingSenderId: "205338430389",
        appId: "1:205338430389:web:10c49d7fc0660b59ece7fc",
        measurementId: "G-CBFDSRCK"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. APP STATE
    const CORRECT_PIN = "000000";
    let currentPin = "";
    let records = []; 
    let currentDate = new Date();
    let barChart, doughnutChart;

    const catInfo = {
        income: { color: '#2ecc71', label: 'Income' },
        safety: { color: '#6C5CE7', label: 'Safety' },
        invest_stock: { color: '#00cec9', label: 'Stocks (Inv)' },
        invest_funds: { color: '#0fbcf9', label: 'Funds (Inv)' },
        invest_gold: { color: '#ffdd59', label: 'Gold (Inv)' },
        invest_etc: { color: '#485460', label: 'Etc. (Inv)' },
        flex: { color: '#fdcb6e', label: 'Flex' },
        fixed: { color: '#ff7675', label: 'Fixed' },
        lock: { color: '#d63031', label: 'Emergency' }
    };

    // 3. CORE FUNCTIONS
    function loadDataFromFirebase() {
        db.ref('fin_records').on('value', (snapshot) => {
            const data = snapshot.val();
            records = data ? Object.values(data) : [];
            updateUI();
        });
    }

    function sync() {
        db.ref('fin_records').set(records);
    }

    function updateUI() {
        renderStats();
        renderCalendar();
        renderBuckets();
        updateCharts();
    }

    // --- AUTH LOGIC ---
    function pressNum(num) {
        if (num === 'C') { currentPin = ""; }
        else if (currentPin.length < 6) { currentPin += num; }
        updatePinDots();
        if (currentPin.length === 6) {
            if (currentPin === CORRECT_PIN) {
                document.getElementById('loginScreen').style.transform = 'translateY(-100%)';
                document.getElementById('mainApp').style.display = 'block';
                setTimeout(() => { document.getElementById('loginScreen').style.display = 'none'; }, 500);
            } else { 
                alert("‡∏£‡∏´‡∏±‡∏™ PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!"); 
                clearPin(); 
            }
        }
    }
    function updatePinDots() {
        const dots = document.querySelectorAll('.pin-dot');
        dots.forEach((dot, i) => i < currentPin.length ? dot.classList.add('active') : dot.classList.remove('active'));
    }
    function clearPin() { currentPin = ""; updatePinDots(); }

    // --- DASHBOARD LOGIC ---
    function saveRecord() {
        const r = {
            id: Date.now(),
            date: document.getElementById('formDate').value,
            title: document.getElementById('formTitle').value,
            amount: parseFloat(document.getElementById('formAmount').value),
            type: document.getElementById('formType').value,
            category: document.getElementById('formCat').value
        };
        if(!r.date || isNaN(r.amount)) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        records.push(r);
        sync();
        closeModal();
    }

    function deleteRecord(id) {
        if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) {
            records = records.filter(x => x.id !== id);
            sync();
            closeDetails();
        }
    }

    function renderStats() {
        const selectedMonthStart = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const previousRecs = records.filter(r => new Date(r.date) < selectedMonthStart);
        const carryOver = previousRecs.reduce((sum, r) => r.type === 'income' ? sum + r.amount : sum - r.amount, 0);
        
        const monthStr = currentDate.toISOString().slice(0, 7);
        const mRecs = records.filter(r => r.date.startsWith(monthStr));
        const mInc = mRecs.filter(r => r.type === 'income').reduce((a,b)=>a+b.amount,0);
        const mExp = mRecs.filter(r => r.type === 'expense').reduce((a,b)=>a+b.amount,0);

        document.getElementById('carryOverDisplay').innerText = carryOver.toLocaleString() + ' ‡∏ø';
        document.getElementById('monthlyExpDisplay').innerText = mExp.toLocaleString() + ' ‡∏ø';
        document.getElementById('grandTotalDisplay').innerText = (carryOver + mInc - mExp).toLocaleString() + ' ‡∏ø';
    }

    function renderBuckets() {
        const container = document.getElementById('buckets');
        container.innerHTML = '';
        const mStr = currentDate.toISOString().slice(0, 7);
        const mRecs = records.filter(r => r.date.startsWith(mStr));

        const categoriesToShow = ['safety', 'invest_stock', 'invest_funds', 'invest_gold', 'invest_etc', 'flex', 'fixed', 'lock'];
        categoriesToShow.forEach(cat => {
            const spent = mRecs.filter(r => r.category === cat && r.type === 'expense').reduce((a,b)=>a+b.amount,0);
            container.innerHTML += `
                <div class="card" style="padding:15px; border-left: 5px solid ${catInfo[cat].color}">
                    <small style="color:#666">${catInfo[cat].label}</small>
                    <p style="margin:5px 0; font-weight:bold; font-size:1.1rem;">${spent.toLocaleString()} ‡∏ø</p>
                </div>`;
        });
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        const y = currentDate.getFullYear(), m = currentDate.getMonth();
        document.getElementById('monthLabel').innerText = new Intl.DateTimeFormat('th-TH', {month:'long', year:'numeric'}).format(currentDate);
        
        const first = new Date(y, m, 1).getDay();
        const days = new Date(y, m+1, 0).getDate();

        for(let i=0; i<first; i++) grid.innerHTML += '<div></div>';
        for(let d=1; d<=days; d++) {
            const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const dayRecords = records.filter(r => r.date === dStr);
            const badge = dayRecords.length > 0 ? `<div class="badge">${dayRecords.length}</div>` : '';
            grid.innerHTML += `<div class="day" onclick="showDay('${dStr}')">${badge}<strong>${d}</strong></div>`;
        }
    }

    function initCharts() {
        const ctxBar = document.getElementById('barChart').getContext('2d');
        barChart = new Chart(ctxBar, {
            type: 'bar',
            data: { labels: ['‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'], datasets: [{ data: [0, 0], backgroundColor: ['#2ecc71', '#ff7675'], borderRadius: 10 }] },
            options: { responsive: true, maintainAspectRatio: false }
        });

        const ctxDonut = document.getElementById('doughnutChart').getContext('2d');
        doughnutChart = new Chart(ctxDonut, {
            type: 'doughnut',
            data: { 
                labels: ['Safety', 'Investing', 'Flex', 'Fixed', 'Emergency'], 
                datasets: [{ 
                    data: [0,0,0,0,0], 
                    backgroundColor: ['#6C5CE7', '#00cec9', '#fdcb6e', '#ff7675', '#d63031'] 
                }] 
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function updateCharts() {
        const mStr = currentDate.toISOString().slice(0, 7);
        const mRecs = records.filter(r => r.date.startsWith(mStr));
        
        const inc = mRecs.filter(r => r.type === 'income').reduce((a,b)=>a+b.amount,0);
        const exp = mRecs.filter(r => r.type === 'expense').reduce((a,b)=>a+b.amount,0);
        barChart.data.datasets[0].data = [inc, exp];
        barChart.update();

        const getSum = (cat) => mRecs.filter(r => r.category === cat && r.type === 'expense').reduce((a,b)=>a+b.amount,0);
        const invSum = getSum('invest_stock') + getSum('invest_funds') + getSum('invest_gold') + getSum('invest_etc');
        
        doughnutChart.data.datasets[0].data = [getSum('safety'), invSum, getSum('flex'), getSum('fixed'), getSum('lock')];
        doughnutChart.update();
    }

    // --- MODAL CONTROL ---
    function openModal() { document.getElementById('recordModal').style.display='flex'; document.getElementById('formDate').valueAsDate = new Date(); }
    function closeModal() { document.getElementById('recordModal').style.display='none'; }
    function closeDetails() { document.getElementById('detailsModal').style.display='none'; }
    function changeMonth(v) { currentDate.setMonth(currentDate.getMonth()+v); updateUI(); }

    function showDay(d) {
        document.getElementById('detailDateLabel').innerText = d;
        const list = records.filter(r => r.date === d);
        document.getElementById('dayList').innerHTML = list.length ? list.map(r => `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; border-bottom:1px solid #eee; padding-bottom:8px;">
                <span>
                    <strong>${r.title}</strong><br>
                    <small style="color:${r.type==='income'?'green':'red'}">${r.type==='income'?'+':'-'}${r.amount.toLocaleString()} ‡∏ø</small>
                    <small> | ${catInfo[r.category]?.label || r.category}</small>
                </span>
                <button class="btn" style="padding:5px 10px; background:#ff7675; color:white; font-size:11px;" onclick="deleteRecord(${r.id})">‡∏•‡∏ö</button>
            </div>
        `).join('') : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
        document.getElementById('detailsModal').style.display='flex';
    }

    // --- START APP ---
    window.onload = () => { 
        initCharts(); 
        loadDataFromFirebase(); 
    };
</script>

</body>
</html>
