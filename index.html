<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Private Finance App</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #6C5CE7; --primary-dark: #4834D4; --bg: #F4F7FE; --shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); overflow-x: hidden; }

        /* --- LOGIN & PIN --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
        }
        .pin-container { display: flex; gap: 10px; margin: 20px 0; }
        .pin-dot { width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; }
        .pin-dot.active { background: white; transform: scale(1.2); }
        .numpad { display: grid; grid-template-columns: repeat(3, 80px); gap: 15px; }
        .num-btn {
            width: 80px; height: 80px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1); color: white; font-size: 1.5rem; cursor: pointer;
        }

        /* --- APP UI --- */
        #mainApp { display: none; padding-bottom: 50px; }
        .header {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            padding: 15px 20px; margin: 10px; border-radius: 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow); position: sticky; top: 10px; z-index: 100;
        }
        .container { max-width: 1200px; margin: auto; padding: 0 15px; }
        .card { background: white; border-radius: 20px; padding: 20px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .summary-banner {
            background: linear-gradient(135deg, #6C5CE7, #a29bfe); color: white;
            border-radius: 25px; padding: 25px; margin: 10px; box-shadow: var(--shadow);
        }
        
        .grid-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .chart-box { height: 220px; position: relative; }

        /* --- MODAL --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 1000;
            align-items: center; justify-content: center;
        }
        .modal-content { background: white; padding: 25px; border-radius: 25px; width: 90%; max-width: 400px; }

        .btn { border: none; padding: 12px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #ddd; }

        @media (max-width: 768px) { .grid-charts { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="loginScreen">
    <h1 id="loginTitle">üîí ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h1>
    <div class="pin-container" id="pinDots">
        <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
    </div>
    <div class="numpad" id="loginPad">
        </div>
</div>

<div id="mainApp">
    <header class="header">
        <div style="display:flex; gap:5px;">
            <button class="btn" onclick="changeMonth(-1)">‚óÄ</button>
            <span id="monthLabel" style="font-weight:bold; align-self:center;"></span>
            <button class="btn" onclick="changeMonth(1)">‚ñ∂</button>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn" onclick="openSettings()" style="background:#eee;">‚öôÔ∏è</button>
            <button class="btn btn-primary" style="width:auto;" onclick="openModal()">‚ûï</button>
        </div>
    </header>

    <div class="summary-banner">
        <small>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏£‡∏ß‡∏°‡∏¢‡∏Å‡∏¢‡∏≠‡∏î</small>
        <h1 id="grandTotalDisplay" style="margin:5px 0; font-size: 2.5rem;">0 ‡∏ø</h1>
        <div style="display:flex; justify-content:space-between; opacity:0.9; font-size:0.9rem;">
            <span>‡∏¢‡∏Å‡∏°‡∏≤: <span id="carryOverDisplay">0</span></span>
            <span>‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <span id="monthlyExpDisplay">0</span></span>
        </div>
    </div>

    <div class="container">
        <div class="grid-charts">
            <div class="card"><div class="chart-box"><canvas id="barChart"></canvas></div></div>
            <div class="card"><div class="chart-box"><canvas id="donutChart"></canvas></div></div>
        </div>
        <div class="card">
            <h3>üóìÔ∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
            <div id="calendarGrid" style="display:grid; grid-template-columns:repeat(7, 1fr); gap:8px;"></div>
        </div>
    </div>
</div>

<div class="modal" id="recordModal">
    <div class="modal-content">
        <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
        <input type="date" id="formDate">
        <input type="text" id="formTitle" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
        <input type="number" id="formAmount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
        <select id="formType">
            <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (+)</option>
            <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (-)</option>
        </select>
        <select id="formCat">
            <option value="income">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
            <option value="safety">üõ°Ô∏è Safety</option>
            <option value="investing">üìà Investing</option>
            <option value="flex">üéà Flex</option>
            <option value="fixed">üßæ Fixed</option>
            <option value="lock">üöë Emergency</option>
        </select>
        <button class="btn btn-primary" onclick="saveRecord()">‡∏ï‡∏Å‡∏•‡∏á</button>
        <button class="btn" style="width:100%; margin-top:10px;" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
</div>

<div class="modal" id="settingsModal">
    <div class="modal-content">
        <h3>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
        <input type="password" id="oldPin" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏¥‡∏°" maxlength="6">
        <input type="password" id="newPin" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà 6 ‡∏´‡∏•‡∏±‡∏Å" maxlength="6">
        <button class="btn btn-primary" onclick="updatePin()">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
        <button class="btn" style="width:100%; margin-top:10px;" onclick="document.getElementById('settingsModal').style.display='none'">‡∏õ‡∏¥‡∏î</button>
    </div>
</div>

<script>
    // --- PIN SYSTEM ---
    let userPin = localStorage.getItem('app_pin') || "123456";
    let inputPin = "";

    function renderNumpad() {
        const pad = document.getElementById('loginPad');
        pad.innerHTML = "";
        [1,2,3,4,5,6,7,8,9,'C',0,'Del'].forEach(val => {
            const btn = document.createElement('button');
            btn.className = 'num-btn';
            btn.innerText = val;
            btn.onclick = () => handlePin(val);
            pad.appendChild(btn);
        });
    }

    function handlePin(val) {
        if(val === 'C') inputPin = "";
        else if(val === 'Del') inputPin = inputPin.slice(0, -1);
        else if(inputPin.length < 6) inputPin += val;

        const dots = document.querySelectorAll('.pin-dot');
        dots.forEach((dot, i) => dot.className = i < inputPin.length ? 'pin-dot active' : 'pin-dot');

        if(inputPin.length === 6) {
            if(inputPin === userPin) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                initCharts(); updateUI();
            } else {
                alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!"); inputPin = ""; handlePin('C');
            }
        }
    }

    function openSettings() { document.getElementById('settingsModal').style.display='flex'; }
    function updatePin() {
        const old = document.getElementById('oldPin').value;
        const next = document.getElementById('newPin').value;
        if(old === userPin && next.length === 6) {
            localStorage.setItem('app_pin', next);
            userPin = next;
            alert("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            location.reload();
        } else { alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!"); }
    }

    // --- LOGIC APP ---
    let records = JSON.parse(localStorage.getItem('my_data')) || [];
    let currentDate = new Date();
    let bChart, dChart;

    function saveRecord() {
        const r = {
            id: Date.now(),
            date: document.getElementById('formDate').value,
            title: document.getElementById('formTitle').value,
            amount: parseFloat(document.getElementById('formAmount').value),
            type: document.getElementById('formType').value,
            category: document.getElementById('formCat').value
        };
        if(!r.date || !r.amount) return;
        records.push(r);
        localStorage.setItem('my_data', JSON.stringify(records));
        updateUI(); closeModal();
    }

    function updateUI() {
        const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const prevRecs = records.filter(r => new Date(r.date) < startOfMonth);
        const carry = prevRecs.reduce((s, r) => r.type === 'income' ? s + r.amount : s - r.amount, 0);

        const mStr = currentDate.toISOString().slice(0, 7);
        const mRecs = records.filter(r => r.date.startsWith(mStr));
        const inc = mRecs.filter(r => r.type === 'income').reduce((a,b)=>a+b.amount,0);
        const exp = mRecs.filter(r => r.type === 'expense').reduce((a,b)=>a+b.amount,0);

        document.getElementById('monthLabel').innerText = new Intl.DateTimeFormat('th-TH', {month:'short', year:'2-digit'}).format(currentDate);
        document.getElementById('carryOverDisplay').innerText = carry.toLocaleString();
        document.getElementById('monthlyExpDisplay').innerText = exp.toLocaleString();
        document.getElementById('grandTotalDisplay').innerText = (carry + inc - exp).toLocaleString() + " ‡∏ø";

        renderCalendar(mRecs);
        if(bChart) updateCharts(inc, exp, mRecs);
    }

    function renderCalendar(mRecs) {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = "";
        const days = new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate();
        for(let d=1; d<=days; d++) {
            const dStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const count = mRecs.filter(r => r.date === dStr).length;
            grid.innerHTML += `<div style="background:#fff; height:45px; border-radius:10px; display:flex; align-items:center; justify-content:center; position:relative; border:1px solid #eee; font-size:0.8rem;">
                ${count > 0 ? '<div style="position:absolute; top:2px; right:2px; width:6px; height:6px; background:red; border-radius:50%;"></div>' : ''}
                ${d}</div>`;
        }
    }

    function initCharts() {
        bChart = new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: { labels: ['In', 'Out'], datasets: [{ data:[0,0], backgroundColor:['#2ecc71','#ff7675'] }] },
            options: { maintainAspectRatio: false }
        });
        dChart = new Chart(document.getElementById('donutChart'), {
            type: 'doughnut',
            data: { labels: ['Flex','Fixed','Invest','Safety','Lock'], datasets: [{ data:[0,0,0,0,0], backgroundColor:['#fdcb6e','#ff7675','#00cec9','#6c5ce7','#d63031'] }] },
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function updateCharts(inc, exp, mRecs) {
        bChart.data.datasets[0].data = [inc, exp]; bChart.update();
        const cats = ['flex','fixed','investing','safety','lock'];
        dChart.data.datasets[0].data = cats.map(c => mRecs.filter(r => r.category === c).reduce((a,b)=>a+b.amount,0));
        dChart.update();
    }

    function changeMonth(v) { currentDate.setMonth(currentDate.getMonth()+v); updateUI(); }
    function openModal() { document.getElementById('recordModal').style.display='flex'; document.getElementById('formDate').valueAsDate = new Date(); }
    function closeModal() { document.getElementById('recordModal').style.display='none'; }
    
    renderNumpad();
</script>
</body>
</html>
