<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Secure Finance Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #6C5CE7;
            --primary-dark: #4834D4;
            --success: #2ecc71;
            --danger: #ff7675;
            --bg: #F4F7FE;
            --shadow-3d: 0 15px 35px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; font-family: 'Kanit', sans-serif; }
        body { margin: 0; background: var(--bg); overflow-x: hidden; }

        /* --- LOGIN SCREEN --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; transition: 0.5s;
        }
        .pin-container { display: flex; gap: 10px; margin: 20px 0; }
        .pin-dot {
            width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;
            transition: 0.2s;
        }
        .pin-dot.active { background: white; transform: scale(1.2); }
        .numpad {
            display: grid; grid-template-columns: repeat(3, 80px); gap: 15px;
            margin-top: 20px;
        }
        .num-btn {
            width: 80px; height: 80px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1); color: white; font-size: 1.5rem; cursor: pointer;
            transition: 0.2s; backdrop-filter: blur(5px);
        }
        .num-btn:active { background: white; color: var(--primary); transform: scale(0.9); }

        /* --- DASHBOARD UI --- */
        #mainApp { display: none; } /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞ Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à */

        .header {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px);
            padding: 20px 30px; margin: 20px; border-radius: 25px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow-3d); position: sticky; top: 20px; z-index: 100;
        }

        .container { max-width: 1200px; margin: auto; padding: 0 20px; }
        .card { background: white; border-radius: 25px; padding: 25px; box-shadow: var(--shadow-3d); transition: 0.4s; }
        .grid-2 { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 20px; margin-bottom: 25px; }
        .grid-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 25px; }

        .summary-banner {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white;
            border-radius: 25px; padding: 30px; margin-bottom: 25px; display: flex;
            justify-content: space-between; align-items: center; box-shadow: var(--shadow-3d);
        }

        .chart-container { height: 250px; position: relative; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 15px; }
        .day {
            background: #fff; height: 80px; border-radius: 18px; position: relative;
            display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #eee;
        }
        .badge {
            position: absolute; top: 5px; right: 5px; background: var(--danger);
            color: white; font-size: 10px; width: 18px; height: 18px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }

        /* --- MODAL --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); z-index: 1000;
            align-items: center; justify-content: center;
        }
        .modal-content { background: white; padding: 30px; border-radius: 30px; width: 400px; box-shadow: 0 40px 80px rgba(0,0,0,0.3); }

        .btn { border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 12px; border: 1px solid #ddd; }

        @media (max-width: 900px) { .grid-charts, .grid-5, .grid-2 { grid-template-columns: 1fr; } .summary-banner { flex-direction: column; text-align: center; gap: 20px; } }
    </style>
</head>
<body>

<div id="loginScreen">
    <div style="text-align:center;">
        <h1 style="margin:0; font-size: 2.5rem;">üîí Finance Lock</h1>
        <p style="opacity:0.8;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ PIN 6 ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
    </div>
    <div class="pin-container" id="pinContainer">
        <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
    </div>
    <div class="numpad">
        <button class="num-btn" onclick="pressNum('1')">1</button>
        <button class="num-btn" onclick="pressNum('2')">2</button>
        <button class="num-btn" onclick="pressNum('3')">3</button>
        <button class="num-btn" onclick="pressNum('4')">4</button>
        <button class="num-btn" onclick="pressNum('5')">5</button>
        <button class="num-btn" onclick="pressNum('6')">6</button>
        <button class="num-btn" onclick="pressNum('7')">7</button>
        <button class="num-btn" onclick="pressNum('8')">8</button>
        <button class="num-btn" onclick="pressNum('9')">9</button>
        <button class="num-btn" onclick="pressNum('C')" style="background:rgba(255,0,0,0.2)">C</button>
        <button class="num-btn" onclick="pressNum('0')">0</button>
        <button class="num-btn" onclick="clearPin()" style="font-size:1rem;">Clear</button>
    </div>
</div>

<div id="mainApp">
    <header class="header">
        <div style="display:flex; align-items:center; gap:10px;">
            <button class="btn" onclick="changeMonth(-1)">‚óÄ</button>
            <h3 id="monthLabel" style="margin:0;">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
            <button class="btn" onclick="changeMonth(1)">‚ñ∂</button>
        </div>
        <button class="btn btn-primary" style="width:auto;" onclick="openModal()">‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </header>

    <main class="container">
        
        <div class="summary-banner">
            <div>
                <small style="opacity:0.9;">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏£‡∏ß‡∏°‡∏¢‡∏Å‡∏¢‡∏≠‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô)</small>
                <h1 style="margin:5px 0; font-size: 3rem;" id="grandTotalDisplay">0 ‡∏ø</h1>
            </div>
            <div style="text-align: right; background: rgba(255,255,255,0.2); padding: 15px; border-radius: 20px;">
                <p style="margin:0;">‡∏¢‡∏≠‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤: <strong id="carryOverDisplay">0 ‡∏ø</strong></p>
                <p style="margin:0;">‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <strong id="monthlyExpDisplay">0 ‡∏ø</strong></p>
            </div>
        </div>

        <section class="grid-charts">
            <div class="card">
                <h3 style="margin-top:0;">üìä Monthly Balance</h3>
                <div class="chart-container"><canvas id="barChart"></canvas></div>
            </div>
            <div class="card">
                <h3 style="margin-top:0;">üçï Expense Mix</h3>
                <div class="chart-container"><canvas id="doughnutChart"></canvas></div>
            </div>
        </section>

        <section class="grid-5" id="buckets"></section>

        <section class="card">
            <h3 style="margin-top:0;">üóìÔ∏è ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
            <div class="calendar-grid" id="calendarGrid"></div>
        </section>
    </main>
</div>

<div class="modal" id="recordModal">
    <div class="modal-content">
        <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà</h2>
        <input type="date" id="formDate">
        <input type="text" id="formTitle" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
        <input type="number" id="formAmount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
        <select id="formType">
            <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (+)</option>
            <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (-)</option>
        </select>
        <select id="formCat">
            <option value="income">üí∞ Income</option>
            <option value="safety">üõ°Ô∏è Safety</option>
            <option value="investing">üìà Investing</option>
            <option value="flex">üéà Flex</option>
            <option value="fixed">üßæ Fixed</option>
            <option value="lock">üöë Emergency</option>
        </select>
        <button class="btn btn-primary" onclick="saveRecord()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="btn" style="width:100%; margin-top:10px;" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
</div>

<div class="modal" id="detailsModal">
    <div class="modal-content">
        <h3 id="detailDateLabel">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</h3>
        <div id="dayList" style="max-height: 200px; overflow-y:auto;"></div>
        <button class="btn" style="width:100%; margin-top:15px;" onclick="closeDetails()">‡∏õ‡∏¥‡∏î</button>
    </div>
</div>

<script>
    // --- PIN LOGIC ---
    const CORRECT_PIN = "123456"; // ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏∞
    let currentPin = "";

    function pressNum(num) {
        if (num === 'C') { currentPin = ""; }
        else if (currentPin.length < 6) { currentPin += num; }
        
        updatePinDots();

        if (currentPin.length === 6) {
            if (currentPin === CORRECT_PIN) {
                document.getElementById('loginScreen').style.transform = 'translateY(-100%)';
                document.getElementById('mainApp').style.display = 'block';
                setTimeout(() => { document.getElementById('loginScreen').style.display = 'none'; }, 500);
            } else {
                alert("‡∏£‡∏´‡∏±‡∏™ PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
                clearPin();
            }
        }
    }

    function updatePinDots() {
        const dots = document.querySelectorAll('.pin-dot');
        dots.forEach((dot, i) => {
            if (i < currentPin.length) dot.classList.add('active');
            else dot.classList.remove('active');
        });
    }

    function clearPin() { currentPin = ""; updatePinDots(); }

    // --- DASHBOARD LOGIC ---
    let records = JSON.parse(localStorage.getItem('fin_v4_recs')) || [];
    let currentDate = new Date();
    let barChart, doughnutChart;

    const catInfo = {
        safety: { color: '#6C5CE7', label: 'Safety' },
        investing: { color: '#00cec9', label: 'Investing' },
        flex: { color: '#fdcb6e', label: 'Flex' },
        fixed: { color: '#ff7675', label: 'Fixed' },
        lock: { color: '#d63031', label: 'Emergency' }
    };

    function saveRecord() {
        const r = {
            id: Date.now(),
            date: document.getElementById('formDate').value,
            title: document.getElementById('formTitle').value,
            amount: parseFloat(document.getElementById('formAmount').value),
            type: document.getElementById('formType').value,
            category: document.getElementById('formCat').value
        };
        if(!r.date || !r.amount) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
        records.push(r);
        sync();
        closeModal();
    }

    function sync() {
        localStorage.setItem('fin_v4_recs', JSON.stringify(records));
        updateUI();
    }

    function updateUI() {
        renderStats();
        renderCalendar();
        updateCharts();
        renderBuckets();
    }

    function renderStats() {
        const selectedMonthStart = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        
        // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        const previousRecs = records.filter(r => new Date(r.date) < selectedMonthStart);
        const carryOver = previousRecs.reduce((sum, r) => r.type === 'income' ? sum + r.amount : sum - r.amount, 0);

        // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
        const monthStr = currentDate.toISOString().slice(0, 7);
        const mRecs = records.filter(r => r.date.startsWith(monthStr));
        const mInc = mRecs.filter(r => r.type === 'income').reduce((a,b)=>a+b.amount,0);
        const mExp = mRecs.filter(r => r.type === 'expense').reduce((a,b)=>a+b.amount,0);

        // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        document.getElementById('carryOverDisplay').innerText = carryOver.toLocaleString() + ' ‡∏ø';
        document.getElementById('monthlyExpDisplay').innerText = mExp.toLocaleString() + ' ‡∏ø';
        document.getElementById('grandTotalDisplay').innerText = (carryOver + mInc - mExp).toLocaleString() + ' ‡∏ø';
    }

    function renderBuckets() {
        const container = document.getElementById('buckets');
        container.innerHTML = '';
        const mStr = currentDate.toISOString().slice(0, 7);
        const mRecs = records.filter(r => r.date.startsWith(mStr));

        Object.keys(catInfo).forEach(cat => {
            const spent = mRecs.filter(r => r.category === cat && r.type === 'expense').reduce((a,b)=>a+b.amount,0);
            container.innerHTML += `
                <div class="card" style="padding:15px; border-left: 5px solid ${catInfo[cat].color}">
                    <h4 style="margin:0">${catInfo[cat].label}</h4>
                    <p style="margin:5px 0; font-weight:bold;">${spent.toLocaleString()} ‡∏ø</p>
                </div>`;
        });
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        const y = currentDate.getFullYear(), m = currentDate.getMonth();
        document.getElementById('monthLabel').innerText = new Intl.DateTimeFormat('th-TH', {month:'long', year:'numeric'}).format(currentDate);
        
        const first = new Date(y, m, 1).getDay();
        const days = new Date(y, m+1, 0).getDate();

        for(let i=0; i<first; i++) grid.innerHTML += '<div></div>';
        for(let d=1; d<=days; d++) {
            const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const count = records.filter(r => r.date === dStr).length;
            const badge = count > 0 ? `<div class="badge">${count}</div>` : '';
            grid.innerHTML += `<div class="day" onclick="showDay('${dStr}')">${badge}<strong>${d}</strong></div>`;
        }
    }

    function initCharts() {
        const ctxBar = document.getElementById('barChart').getContext('2d');
        barChart = new Chart(ctxBar, {
            type: 'bar',
            data: { labels: ['‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'], datasets: [{ data: [0, 0], backgroundColor: ['#2ecc71', '#ff7675'], borderRadius: 10 }] },
            options: { responsive: true, maintainAspectRatio: false }
        });

        const ctxDonut = document.getElementById('doughnutChart').getContext('2d');
        doughnutChart = new Chart(ctxDonut, {
            type: 'doughnut',
            data: { labels: Object.keys(catInfo).map(k => catInfo[k].label), datasets: [{ data: [0,0,0,0,0], backgroundColor: Object.keys(catInfo).map(k => catInfo[k].color) }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function updateCharts() {
        const mStr = currentDate.toISOString().slice(0, 7);
        const mRecs = records.filter(r => r.date.startsWith(mStr));
        const inc = mRecs.filter(r => r.type === 'income').reduce((a,b)=>a+b.amount,0);
        const exp = mRecs.filter(r => r.type === 'expense').reduce((a,b)=>a+b.amount,0);
        
        barChart.data.datasets[0].data = [inc, exp];
        barChart.update();

        const catData = Object.keys(catInfo).map(cat => mRecs.filter(r => r.category === cat && r.type === 'expense').reduce((a,b)=>a+b.amount,0));
        doughnutChart.data.datasets[0].data = catData;
        doughnutChart.update();
    }

    function openModal() { document.getElementById('recordModal').style.display='flex'; document.getElementById('formDate').valueAsDate = new Date(); }
    function closeModal() { document.getElementById('recordModal').style.display='none'; }
    function showDay(d) {
        document.getElementById('detailDateLabel').innerText = d;
        const list = records.filter(r => r.date === d);
        document.getElementById('dayList').innerHTML = list.length ? list.map(r => `
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">
                <span>${r.title} (${r.amount}‡∏ø)</span>
                <button class="btn" style="padding:2px 10px; background:#ff7675; color:white;" onclick="deleteRecord(${r.id})">‡∏•‡∏ö</button>
            </div>
        `).join('') : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
        document.getElementById('detailsModal').style.display='flex';
    }
    function deleteRecord(id) {
        records = records.filter(x => x.id !== id);
        sync();
        closeDetails();
    }
    function closeDetails() { document.getElementById('detailsModal').style.display='none'; }
    function changeMonth(v) { currentDate.setMonth(currentDate.getMonth()+v); updateUI(); }

    window.onload = () => { initCharts(); updateUI(); };
</script>

</body>
</html>
